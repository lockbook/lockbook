{
  "db": "PostgreSQL",
  "0378be30e1d712ef25da62ed79412d2a8f1ed6dbbcf677e507589f531e6983da": {
    "query": "\nSELECT\n    files.*,\n    user_access_keys.encrypted_key AS \"encrypted_key?\",\n    accounts.public_key,\n    accounts.name AS username\nFROM files\nJOIN accounts ON files.owner = accounts.public_key\nLEFT JOIN user_access_keys ON files.id = user_access_keys.file_id AND accounts.public_key = user_access_keys.sharee\nWHERE\n    accounts.public_key = $1 AND\n    metadata_version > $2;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "id",
          "type_info": "Text"
        },
        {
          "ordinal": 1,
          "name": "parent",
          "type_info": "Text"
        },
        {
          "ordinal": 2,
          "name": "parent_access_key",
          "type_info": "Text"
        },
        {
          "ordinal": 3,
          "name": "is_folder",
          "type_info": "Bool"
        },
        {
          "ordinal": 4,
          "name": "name_encrypted",
          "type_info": "Text"
        },
        {
          "ordinal": 5,
          "name": "name_hmac",
          "type_info": "Text"
        },
        {
          "ordinal": 6,
          "name": "owner",
          "type_info": "Text"
        },
        {
          "ordinal": 7,
          "name": "deleted",
          "type_info": "Bool"
        },
        {
          "ordinal": 8,
          "name": "metadata_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 9,
          "name": "content_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 10,
          "name": "document_size",
          "type_info": "Int8"
        },
        {
          "ordinal": 11,
          "name": "encrypted_key?",
          "type_info": "Text"
        },
        {
          "ordinal": 12,
          "name": "public_key",
          "type_info": "Text"
        },
        {
          "ordinal": 13,
          "name": "username",
          "type_info": "Text"
        }
      ],
      "parameters": {
        "Left": [
          "Text",
          "Int8"
        ]
      },
      "nullable": [
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        true,
        false,
        false,
        false
      ]
    }
  },
  "12be31a805736cd77161fe0860485c91885dd98b551927d250d143334494aa71": {
    "query": "\nSELECT public_key FROM accounts WHERE name = $1;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "public_key",
          "type_info": "Text"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        false
      ]
    }
  },
  "28b05a758fa44ead5f15283ea15974546be35f0c38240b8a23c8fc054bdf0202": {
    "query": "\nINSERT INTO user_access_keys (file_id, sharee, encrypted_key) VALUES ($1, $2, $3);\n        ",
    "describe": {
      "columns": [],
      "parameters": {
        "Left": [
          "Text",
          "Text",
          "Text"
        ]
      },
      "nullable": []
    }
  },
  "3d22ca688800d30311bf15d2bb6a00db805eb034f8c9918f7f3f326995fce337": {
    "query": "\nWITH RECURSIVE file_ancestors AS (\n    SELECT * FROM files AS new_file_parent\n    WHERE new_file_parent.id = $2\n        UNION DISTINCT\n    SELECT ancestors.* FROM files AS ancestors\n    JOIN file_ancestors ON file_ancestors.parent = ancestors.id\n),\ninsert_cte AS (\n    INSERT INTO files (\n        id,\n        parent,\n        parent_access_key,\n        is_folder,\n        name_encrypted,\n        name_hmac,\n        owner,\n        deleted,\n        metadata_version,\n        content_version,\n        document_size\n    )\n    SELECT\n        $1,\n        $2,\n        $3,\n        $4,\n        $5,\n        $6,\n        $7,\n        FALSE,\n        CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT),\n        CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT),\n        $8\n    WHERE NOT EXISTS(SELECT * FROM file_ancestors WHERE deleted)\n    RETURNING NULL\n)\nSELECT\n    CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT) AS \"metadata_version!\",\n    EXISTS(SELECT * FROM file_ancestors WHERE deleted) AS \"ancestor_deleted!\";\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "metadata_version!",
          "type_info": "Int8"
        },
        {
          "ordinal": 1,
          "name": "ancestor_deleted!",
          "type_info": "Bool"
        }
      ],
      "parameters": {
        "Left": [
          "Text",
          "Text",
          "Text",
          "Bool",
          "Text",
          "Text",
          "Text",
          "Int8"
        ]
      },
      "nullable": [
        null,
        null
      ]
    }
  },
  "4ea63bf2021871af921d25456594b18f755df32e034880b301f7b291ffa11ac7": {
    "query": "\nDELETE FROM accounts where name = $1\n        ",
    "describe": {
      "columns": [],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": []
    }
  },
  "5250df34c04f9260c2683ff358e135ebee12675cb840c324d72214ca3df3156f": {
    "query": "\n        WITH RECURSIVE not_sure AS (\n            SELECT\n                FALSE AS i,\n                id AS id,\n                parent AS parent,\n                (SELECT parent_files.parent FROM files AS parent_files WHERE parent_files.id = files.parent) AS grandparent\n            FROM files\n            WHERE owner = $1\n                UNION DISTINCT\n            SELECT\n                TRUE AS i,\n                id AS id,\n                (SELECT parent_files.parent FROM files AS parent_files WHERE parent_files.id = not_sure.parent) AS parent,\n                (SELECT grandparent_files.parent FROM files AS grandparent_files WHERE grandparent_files.id = (SELECT parent_files.parent FROM files AS parent_files WHERE id = (SELECT files.parent FROM files WHERE id = not_sure.parent))) AS grandparent\n            FROM not_sure\n            WHERE parent != grandparent\n        )\n        SELECT COUNT(*) != 0 AS \"has_cycles!\" FROM not_sure WHERE id = parent AND i;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "has_cycles!",
          "type_info": "Bool"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        null
      ]
    }
  },
  "65d57d7f9e7f5c969fdbb3285a37bb21a27bea539b58f4e1cebc9912bef23a11": {
    "query": "\nSELECT\n    files.*,\n    user_access_keys.encrypted_key AS \"encrypted_key?\",\n    accounts.public_key,\n    accounts.name AS username\nFROM files\nJOIN accounts ON files.owner = accounts.public_key\nLEFT JOIN user_access_keys ON files.id = user_access_keys.file_id AND accounts.public_key = user_access_keys.sharee\nWHERE\n    accounts.public_key = $1;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "id",
          "type_info": "Text"
        },
        {
          "ordinal": 1,
          "name": "parent",
          "type_info": "Text"
        },
        {
          "ordinal": 2,
          "name": "parent_access_key",
          "type_info": "Text"
        },
        {
          "ordinal": 3,
          "name": "is_folder",
          "type_info": "Bool"
        },
        {
          "ordinal": 4,
          "name": "name_encrypted",
          "type_info": "Text"
        },
        {
          "ordinal": 5,
          "name": "name_hmac",
          "type_info": "Text"
        },
        {
          "ordinal": 6,
          "name": "owner",
          "type_info": "Text"
        },
        {
          "ordinal": 7,
          "name": "deleted",
          "type_info": "Bool"
        },
        {
          "ordinal": 8,
          "name": "metadata_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 9,
          "name": "content_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 10,
          "name": "document_size",
          "type_info": "Int8"
        },
        {
          "ordinal": 11,
          "name": "encrypted_key?",
          "type_info": "Text"
        },
        {
          "ordinal": 12,
          "name": "public_key",
          "type_info": "Text"
        },
        {
          "ordinal": 13,
          "name": "username",
          "type_info": "Text"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        false,
        true,
        false,
        false,
        false
      ]
    }
  },
  "6b9623fcb7225594e76b6451a768a1290d83156f16aeb73197a20997c6d0ffd9": {
    "query": "\nWITH\n    preconditions AS (\n        SELECT\n            -- both args empty and file does not exist...\n            ($9 = '' AND $10 = '' AND NOT EXISTS(SELECT * FROM files WHERE id = $1)) OR\n            -- ...or neither arg empty and matching file exists\n            ($9 != '' AND $10 != '' AND EXISTS(SELECT * FROM files WHERE id = $1 AND is_folder = $4 AND parent = $9 AND name_hmac = $10)) AS met\n            UNION ALL\n        -- new parent must be a folder if it exists already\n        SELECT NOT EXISTS(SELECT * FROM files WHERE id = $2 AND NOT is_folder) AS met\n            UNION ALL\n        -- cannot have children if document\n        SELECT $4 OR NOT EXISTS(SELECT * FROM files WHERE parent = $1) AS met\n    ),\n    insert AS (\n        INSERT INTO files (\n            id,\n            parent,\n            parent_access_key,\n            is_folder,\n            name_encrypted,\n            name_hmac,\n            owner,\n            deleted,\n            metadata_version,\n            content_version,\n            document_size\n        )\n        SELECT\n            $1,\n            $2,\n            $3,\n            $4,\n            $5,\n            $6,\n            $7,\n            $8,\n            CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT),\n            0,\n            0\n        ON CONFLICT (id) DO UPDATE SET\n            metadata_version =\n                (CASE WHEN (SELECT BOOL_AND(met) FROM preconditions)\n                THEN CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT)\n                ELSE files.metadata_version END),\n            parent =\n                (CASE WHEN (SELECT BOOL_AND(met) FROM preconditions)\n                THEN $2\n                ELSE files.parent END),\n            parent_access_key =\n                (CASE WHEN (SELECT BOOL_AND(met) FROM preconditions)\n                THEN $3\n                ELSE files.parent_access_key END),\n            name_encrypted =\n                (CASE WHEN (SELECT BOOL_AND(met) FROM preconditions)\n                THEN $5\n                ELSE files.name_encrypted END),\n            name_hmac =\n                (CASE WHEN (SELECT BOOL_AND(met) FROM preconditions)\n                THEN $6\n                ELSE files.name_hmac END),\n            deleted =\n                (CASE WHEN (SELECT BOOL_AND(met) FROM preconditions)\n                THEN excluded.deleted OR $8\n                ELSE files.deleted END)\n    )\nSELECT\n    BOOL_AND(met) AS \"preconditions_met!\",\n    CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT) AS \"version!\"\nFROM preconditions;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "preconditions_met!",
          "type_info": "Bool"
        },
        {
          "ordinal": 1,
          "name": "version!",
          "type_info": "Int8"
        }
      ],
      "parameters": {
        "Left": [
          "Text",
          "Text",
          "Text",
          "Bool",
          "Text",
          "Text",
          "Text",
          "Bool",
          "Text",
          "Text"
        ]
      },
      "nullable": [
        null,
        null
      ]
    }
  },
  "7cb24bd257993562cb5b2e2e3cd3f60345ce5644dff579fe7c03ba6916e4795b": {
    "query": "\nWITH old AS (SELECT * FROM files WHERE id = $1 FOR UPDATE)\nUPDATE files new\nSET\n    metadata_version =\n        (CASE WHEN NOT old.deleted AND old.metadata_version = $2 AND NOT old.is_folder\n        THEN CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT)\n        ELSE old.metadata_version END),\n    content_version =\n        (CASE WHEN NOT old.deleted AND old.metadata_version = $2 AND NOT old.is_folder\n        THEN CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT)\n        ELSE old.content_version END),\n    document_size = \n        (CASE WHEN NOT old.deleted AND old.metadata_version = $2 AND NOT old.is_folder\n        THEN $3\n        ELSE old.document_size END)\nFROM old\nWHERE old.id = new.id\nRETURNING\n    old.deleted AS old_deleted,\n    old.metadata_version AS old_metadata_version,\n    old.content_version AS old_content_version,\n    old.parent AS parent_id,\n    new.metadata_version AS new_metadata_version,\n    old.is_folder AS is_folder;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "old_deleted",
          "type_info": "Bool"
        },
        {
          "ordinal": 1,
          "name": "old_metadata_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 2,
          "name": "old_content_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 3,
          "name": "parent_id",
          "type_info": "Text"
        },
        {
          "ordinal": 4,
          "name": "new_metadata_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 5,
          "name": "is_folder",
          "type_info": "Bool"
        }
      ],
      "parameters": {
        "Left": [
          "Text",
          "Int8",
          "Int8"
        ]
      },
      "nullable": [
        false,
        false,
        false,
        false,
        false,
        false
      ]
    }
  },
  "87ae69308a4ffbaffabc065553004331f17cd9c0bdad005b1e8c9e9f5f2c2a82": {
    "query": "\nSELECT bytes_cap\nFROM account_tiers\nWHERE id =\n    (SELECT account_tier FROM accounts WHERE public_key = $1);\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "bytes_cap",
          "type_info": "Int8"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        false
      ]
    }
  },
  "88a3b8b4f839d31f47c47d46cd4617f48973a7abe8a116fdb9dbade43df8bf22": {
    "query": "\n    WITH RECURSIVE file_ancestors AS (\n        SELECT id, id AS ancestor FROM files\n            UNION DISTINCT\n        SELECT file_ancestors.id, files.parent AS ancestor FROM files\n        JOIN file_ancestors ON files.id = file_ancestors.ancestor\n    ),\n    files_with_deleted_ancestors AS (\n        SELECT id FROM files WHERE EXISTS(\n            SELECT * FROM file_ancestors\n            JOIN files AS ancestor_files ON file_ancestors.ancestor = ancestor_files.id\n            WHERE files.id = file_ancestors.id AND ancestor_files.deleted\n        )\n    )\n    SELECT\n        files.id,\n        CASE WHEN EXISTS(SELECT * FROM files_with_deleted_ancestors WHERE files_with_deleted_ancestors.id = files.id) THEN 0 ELSE files.document_size END AS \"document_size!\"\n    FROM files\n    WHERE\n        files.owner = $1 AND\n        NOT files.is_folder;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "id",
          "type_info": "Text"
        },
        {
          "ordinal": 1,
          "name": "document_size!",
          "type_info": "Int8"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        false,
        null
      ]
    }
  },
  "959f62b7e1270148112b3a230e1690f8dd3eccf6012d400fec6ca494225bbc14": {
    "query": "\n        WITH RECURSIVE effective_deleted AS (\n            SELECT\n                id,\n                parent,\n                deleted\n            FROM files\n            WHERE owner = $1\n                UNION DISTINCT\n            SELECT\n                effective_deleted.id,\n                files.parent,\n                effective_deleted.deleted OR files.deleted\n            FROM effective_deleted\n            JOIN files ON effective_deleted.parent = files.id\n        ),\n        deletions AS (\n            SELECT\n                effective_deleted.id\n            FROM effective_deleted\n            JOIN files ON effective_deleted.id = files.id\n            WHERE effective_deleted.deleted AND NOT files.deleted\n        )\n        UPDATE files SET\n            deleted = true,\n            metadata_version = CAST(EXTRACT(EPOCH FROM NOW()) * 1000 AS BIGINT)\n        WHERE id IN (SELECT id FROM deletions)\n        RETURNING id AS \"id!\";\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "id!",
          "type_info": "Text"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        false
      ]
    }
  },
  "b9d28fb984c7871adfe5eeb0dd2c5bedb4ca3a45d448e3b6b68da796adc10b23": {
    "query": "\nDELETE FROM files\nWHERE owner = $1\nRETURNING\n    id AS id,\n    deleted AS old_deleted,\n    parent AS parent_id,\n    content_version AS old_content_version,\n    metadata_version AS new_metadata_version,\n    is_folder AS is_folder;\n        ",
    "describe": {
      "columns": [
        {
          "ordinal": 0,
          "name": "id",
          "type_info": "Text"
        },
        {
          "ordinal": 1,
          "name": "old_deleted",
          "type_info": "Bool"
        },
        {
          "ordinal": 2,
          "name": "parent_id",
          "type_info": "Text"
        },
        {
          "ordinal": 3,
          "name": "old_content_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 4,
          "name": "new_metadata_version",
          "type_info": "Int8"
        },
        {
          "ordinal": 5,
          "name": "is_folder",
          "type_info": "Bool"
        }
      ],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": [
        false,
        false,
        false,
        false,
        false,
        false
      ]
    }
  },
  "e443b4758b8d5ff620d449a0c0f8ceb797fb0ad6cf084390ea3dad269965c1a8": {
    "query": "\nDELETE FROM user_access_keys where sharee = $1\n        ",
    "describe": {
      "columns": [],
      "parameters": {
        "Left": [
          "Text"
        ]
      },
      "nullable": []
    }
  },
  "ee181bf167dc57995d471a2f17c0af1fef964cbb69b9d4f716ed4945cea20310": {
    "query": "\nWITH i1 AS (\n    INSERT INTO account_tiers (bytes_cap) VALUES (1000000) RETURNING id\n)\nINSERT INTO accounts (name, public_key, account_tier) VALUES ($1, $2, (SELECT id FROM i1))\n        ",
    "describe": {
      "columns": [],
      "parameters": {
        "Left": [
          "Text",
          "Text"
        ]
      },
      "nullable": []
    }
  }
}