name: Integration

on:
  push:
    branches: [ master ]
    paths-ignore:
      - docs/**
  pull_request:
    branches: [ master ]

jobs:
  Checks:
    runs-on: [self-hosted, ci]
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      LOCKBOOK_CI: 1
    steps:
    - uses: actions/checkout@v2
    - name: Set Rust Version
      run: rustup default 1.63
    - name: Check Workspace Fmt
      run: cargo run -p lockbook-dev -- check-workspace-fmt
    - name: Check Workspace Clippy
      run: cargo run -p lockbook-dev -- check-workspace-clippy
    - name: Run Server
      run: cargo run -p lockbook-dev -- run-server
    - name: Run Rust Tests
      run: cargo run -p lockbook-dev -- run-rust-tests
    - name: Run Android Fmt
      run: cargo run -p lockbook-dev -- check-android-fmt
    - name: Run Android Lint
      run: cargo run -p lockbook-dev -- check-android-lint
    - name: Run Kotlin Tests
      run: cargo run -p lockbook-dev -- run-kotlin-tests
    - name: Run Swift Tests
      run: cargo run -p lockbook-dev -- run-swift-tests
    - name: Cleanup
      if: always()
      run: cargo run -p lockbook-dev -- kill-server
