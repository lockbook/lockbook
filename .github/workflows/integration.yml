name: Integration

on:
  push:
    branches: [ master ]
    paths-ignore:
      - docs/**
  pull_request:
    branches: [ master ]

jobs:
  Checks:
    runs-on: [self-hosted, ci]
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      LOCKBOOK_CI: 1
    steps:
    - uses: actions/checkout@v2
    - name: Check Workspace Fmt
      run: cargo run -p lockbook-dev -- check-workspace-fmt
    - name: Check Workspace Clippy
      run: cargo run -p lockbook-dev -- check-workspace-clippy
    - name: Build Server
      run: cargo run -p lockbook-dev -- build-server
    - name: Run Server
      run: cargo run -p lockbook-dev -- run-server
    - name: Run Rust Tests
      run: cargo run -p lockbook-dev -- run-rust-tests
    - name: Run Android Fmt
      run: cargo run -p lockbook-dev -- run-android-fmt
    - name: Run Android Lint
      run: cargo run -p lockbook-dev -- run-android-lint
    - name: Run Swift Tests
      run: cargo run -p lockbook-dev -- run-swift-tests

  Cleanup:
    runs-on: [self-hosted, ci]
    needs: [ Checks ]
    if: always()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      LOCKBOOK_CI: 1
    steps:
      - uses: actions/checkout@v2
      - name: Cleanup
        run: cargo run -p lockbook-dev -- kill-server
